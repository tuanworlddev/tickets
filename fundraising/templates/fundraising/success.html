{% extends 'fundraising/base.html' %}

{% block content %}
<div class="row text-center">
    <div class="col-md-8 offset-md-2">
        <h2 class="text-success mb-4">Quét Mã QR Để Thanh Toán</h2>
        <p class="lead">Cảm ơn bạn đã ủng hộ SVCG An Thượng.</p>

        <div class="card shadow p-4 mb-4">
            <h4 class="mb-3">Thông tin thanh toán</h4>
            <div id="qr-container" class="d-flex justify-content-center align-items-center" style="min-height: 300px;">
                {% if qr_url %}
                <img src="{{ qr_url }}" alt="VietQR" style="max-width: 100%;">
                {% else %}
                <div class="alert alert-warning">Không thể tạo mã QR tự động. Vui lòng chuyển khoản thủ công.</div>
                {% endif %}
            </div>
            <p class="mt-3 text-muted">Vui lòng quét mã QR để chuyển khoản.</p>
            <p><strong>Số tiền: {{ amount }} đ</strong></p>
        </div>

        <div class="mb-4">
            <h5>Vé của bạn:</h5>
            <div class="row row-cols-1 row-cols-md-2 g-4 justify-content-center">
                {% for ticket in tickets %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <img src="{% url 'serve_ticket_image' ticket.id %}" class="card-img-top ticket-img"
                            alt="Vé {{ ticket.number }}">
                        <div class="card-body p-2 d-flex justify-content-between align-items-center">
                            <span class="badge bg-success">Số: {{ ticket.number }}</span>
                            <a href="{% url 'download_ticket' ticket.id %}"
                                class="btn btn-sm btn-outline-success download-single">
                                <i class="bi bi-download"></i> Tải về
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <p class="mt-3 text-muted small"><i class="bi bi-info-circle"></i> Mẹo mobile: Nhấn giữ vào ảnh vé để lưu
                trực tiếp vào máy.</p>
        </div>

        <div class="mb-4 text-center">
            <button id="download-all-btn" class="btn btn-success btn-lg">
                <i class="bi bi-download"></i> Tải tất cả vé
            </button>
            <div id="download-status" class="mt-2 small text-muted d-none">Đang tải... vui lòng đợi.</div>
        </div>

        <div class="d-flex justify-content-center gap-3">
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#cancelModal">Hủy giao
                dịch</button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#confirmPaymentModal">Tôi đã thanh toán</button>
        </div>
    </div>
</div>

<style>
    .ticket-img {
        transition: transform 0.2s;
        cursor: pointer;
    }

    .ticket-img:hover {
        transform: scale(1.02);
    }
</style>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">Xác nhận hủy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc muốn hủy giao dịch này không? Vé sẽ được mở lại.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                <a href="{% url 'cancel_transaction' %}" class="btn btn-danger">Đồng ý hủy</a>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Payment Modal -->
<div class="modal fade" id="confirmPaymentModal" tabindex="-1" aria-labelledby="confirmPaymentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmPaymentModalLabel">Xác nhận thanh toán</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn đã chuyển khoản thành công chưa?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chưa</button>
                <button type="button" class="btn btn-primary" onclick="showSuccessModal()">Rồi, tôi đã chuyển</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true"
    data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">Thanh toán thành công</h5>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <p class="text-success h1"><i class="bi bi-check-circle-fill"></i></p>
                    <p>Cảm ơn bạn! Giao dịch đã được ghi nhận.</p>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <a href="{% url 'index' %}" class="btn btn-success btn-lg">Về trang chủ</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Clear the selection storage now that we are in success page
    sessionStorage.removeItem('selected_tickets');

    function showSuccessModal() {
        // Hide confirm modal
        var confirmModalEl = document.getElementById('confirmPaymentModal');
        var confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
        confirmModal.hide();

        // Show success modal
        var successModalEl = document.getElementById('successModal');
        var successModal = new bootstrap.Modal(successModalEl);
        successModal.show();
    }

    // Download All logic for mobile/desktop without ZIP
    document.getElementById('download-all-btn').addEventListener('click', function () {
        const links = document.querySelectorAll('.download-single');
        const status = document.getElementById('download-status');

        status.classList.remove('d-none');
        this.disabled = true;

        let delay = 0;
        links.forEach((link, index) => {
            setTimeout(() => {
                const a = document.createElement('a');
                a.href = link.href;
                a.download = ''; // Browser will use filename from Content-Disposition
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                if (index === links.length - 1) {
                    status.classList.add('d-none');
                    this.disabled = false;
                }
            }, delay);
            delay += 1000; // 1 second delay between downloads to prevent browser blocking
        });
    });
</script>
{% endblock %}