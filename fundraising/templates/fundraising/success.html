{% extends 'fundraising/base.html' %}

{% block content %}
<div class="row text-center">
    <div class="col-md-8 offset-md-2">
        <h2 class="text-success mb-4">Quét Mã QR Để Thanh Toán</h2>
        <p class="lead">Cảm ơn bạn đã ủng hộ SVCG An Thượng.</p>

        <div class="card shadow p-4 mb-4">
            <h4 class="mb-3">Thông tin thanh toán</h4>
            <div id="qr-container" class="d-flex justify-content-center align-items-center" style="min-height: 300px;">
                {% if qr_url %}
                <img src="{{ qr_url }}" alt="VietQR" style="max-width: 100%;">
                {% else %}
                <div class="alert alert-warning">Không thể tạo mã QR tự động. Vui lòng chuyển khoản thủ công.</div>
                {% endif %}
            </div>
            <p class="mt-3 text-muted">Vui lòng quét mã QR để chuyển khoản.</p>
            <p><strong>Số tiền: {{ amount }} đ</strong></p>
        </div>

        <div class="mb-4">
            <h5>Vé của bạn:</h5>
            <div class="row row-cols-1 row-cols-md-2 g-4 justify-content-center">
                {% for ticket in tickets %}
                <div class="col">
                    <div class="card h-100 shadow-sm" style="border: 1px solid #d32f2f;">
                        <img src="{% url 'serve_ticket_image' ticket.id %}" class="card-img-top ticket-img"
                            alt="Vé {{ ticket.number }}">
                        <div class="card-body p-2 d-flex justify-content-between align-items-center">
                            <span class="badge bg-success">Số: {{ ticket.number }}</span>
                            <a href="{% url 'download_ticket' ticket.id %}"
                                class="btn btn-sm btn-outline-success download-single">
                                <i class="bi bi-download"></i> Tải về
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <p class="mt-3 text-muted small"><i class="bi bi-info-circle"></i> Mẹo mobile: Nhấn giữ vào ảnh vé để lưu
                trực tiếp vào máy.</p>
        </div>

        <div class="mb-4 text-center">
            <button id="download-all-btn" class="btn btn-sm btn-success btn-lg">
                <i class="bi bi-download"></i> Tải tất cả vé
            </button>
            <div id="download-status" class="mt-2 small text-muted d-none">Đang tải... vui lòng đợi.</div>
        </div>

        <div class="d-flex justify-content-center gap-3">
            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#cancelModal">Hủy
                giao
                dịch</button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#confirmPaymentModal">Tôi đã thanh toán</button>
        </div>
    </div>
</div>

<style>
    .ticket-img {
        transition: transform 0.2s;
        cursor: pointer;
    }

    .ticket-img:hover {
        transform: scale(1.02);
    }
</style>

<!-- Cancel Confirmation Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">Xác nhận hủy</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn có chắc muốn hủy giao dịch này không? Vé sẽ được mở lại.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
                <a href="{% url 'cancel_transaction' %}" class="btn btn-danger">Đồng ý hủy</a>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Payment Modal -->
<div class="modal fade" id="confirmPaymentModal" tabindex="-1" aria-labelledby="confirmPaymentModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmPaymentModalLabel">Xác nhận thanh toán</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Bạn đã chuyển khoản thành công chưa?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chưa</button>
                <button type="button" class="btn btn-primary" onclick="showSuccessModal()">Rồi, tôi đã chuyển</button>
            </div>
        </div>
    </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true"
    data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel">Thanh toán thành công</h5>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <p class="text-success h1"><i class="bi bi-check-circle-fill"></i></p>
                    <p>Cảm ơn bạn! Giao dịch đã được ghi nhận.</p>
                </div>
                <hr>
                <div class="mb-3">
                    <label for="user-message" class="form-label">Gửi lời nhắn bạn muốn nói với người mình thương
                        (tùy chọn):</label>
                    <textarea class="form-control" id="user-message" rows="5"
                        placeholder="Nhập lời nhắn của bạn tại đây..."></textarea>
                    <div class="form-text text-danger mt-1">
                        <i class="bi bi-shield-lock-fill"></i> Danh tính của bạn sẽ được ẩn danh tuyệt đối.
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-outline-danger" id="btn-send-message">Gửi lời
                    nhắn
                    <svg fill="#dc3545" height="16px" width="16px" version="1.1" id="Layer_1"
                        xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
                        viewBox="0 0 511.763 511.763" xml:space="preserve" stroke="#e2037a">
                        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                        <g id="SVGRepo_iconCarrier">
                            <g>
                                <g>
                                    <path
                                        d="M511.716,9.802c-0.107-0.853-0.213-1.707-0.533-2.56c-0.107-0.32-0.213-0.747-0.32-1.067 c-0.533-1.173-1.28-2.24-2.133-3.2c-0.96-0.853-2.027-1.6-3.2-2.133c-0.32-0.107-0.747-0.32-1.067-0.32 c-0.853-0.213-1.707-0.427-2.56-0.427c-0.427,0-0.747,0-1.173,0c-0.96,0-2.027,0.213-2.987,0.533 c-0.213,0.107-0.427,0.107-0.64,0.213h-0.107L6.436,213.962c-5.44,2.347-7.893,8.64-5.547,14.08c0.96,2.24,2.667,4.053,4.8,5.12 l178.347,94.4l94.507,178.347c1.813,3.52,5.44,5.653,9.387,5.76h0.427c4.053-0.107,7.68-2.667,9.387-6.4L510.969,14.815v-0.107 c0.107-0.213,0.107-0.427,0.213-0.64c0.32-0.96,0.533-1.92,0.533-2.987C511.716,10.655,511.822,10.228,511.716,9.802z M35.342,224.522l418.88-182.08l-264.107,264L35.342,224.522z M287.182,476.362l-81.92-154.773l264-264.107L287.182,476.362z">
                                    </path>
                                </g>
                            </g>
                        </g>
                    </svg>
                </button>
                <a href="{% url 'index' %}" class="btn btn-success">Về trang chủ</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Clear the selection storage now that we are in success page
    sessionStorage.removeItem('selected_tickets');

    function showSuccessModal() {
        // Hide confirm modal
        var confirmModalEl = document.getElementById('confirmPaymentModal');
        var confirmModal = bootstrap.Modal.getInstance(confirmModalEl);
        confirmModal.hide();

        // Show success modal
        var successModalEl = document.getElementById('successModal');
        var successModal = new bootstrap.Modal(successModalEl);
        successModal.show();

        // Set suppression flag when successfully paid
        sessionStorage.setItem('hide_letter_modal', 'true');
    }

    // Download All logic for mobile/desktop without ZIP
    document.getElementById('download-all-btn').addEventListener('click', function () {
        const links = document.querySelectorAll('.download-single');
        const status = document.getElementById('download-status');

        status.classList.remove('d-none');
        this.disabled = true;

        let delay = 0;
        links.forEach((link, index) => {
            setTimeout(() => {
                const a = document.createElement('a');
                a.href = link.href;
                a.download = ''; // Browser will use filename from Content-Disposition
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                if (index === links.length - 1) {
                    status.classList.add('d-none');
                    this.disabled = false;
                }
            }, delay);
            delay += 1000; // 1 second delay between downloads to prevent browser blocking
        });
    });

    // AJAX Message Submission
    document.getElementById('btn-send-message').addEventListener('click', function () {
        const message = document.getElementById('user-message').value;
        if (!message.trim()) {
            alert('Vui lòng nhập nội dung lời nhắn.');
            return;
        }

        const btn = this;
        btn.disabled = true;
        btn.innerText = 'Đang gửi...';

        fetch("{% url 'submit_message' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: new URLSearchParams({
                'message': message,
                'name': '{{ tickets.first.buyer_name }}', // Optionally store name but display anonymously
                'phone': '{{ tickets.first.buyer_phone }}'
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    btn.innerText = 'Đã gửi ❤️';
                    document.getElementById('user-message').disabled = true;
                } else {
                    alert('Có lỗi xảy ra: ' + data.message);
                    btn.disabled = false;
                    btn.innerText = 'Gửi lời nhắn';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi gửi lời nhắn.');
                btn.disabled = false;
                btn.innerText = 'Gửi lời nhắn';
            });
    });
</script>
{% endblock %}